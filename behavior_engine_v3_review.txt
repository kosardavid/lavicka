===========================================
BEHAVIOR ENGINE v3.5 - REVIEW PRO CHATGPT
===========================================
Datum: 2025-12-23
Verze: v3.5 (opravy z ChatGPT review v3.4)

ZMĚNY OD v3.4:

1. NOVÉ: Engagement v scoringu
   - Vysoký engagement (≥ 0.5) = bonus: +0.15 * (eng - 0.5) * 2
   - Nízký engagement (< 0.25) = penalizace: -0.20 * (0.25 - eng) * 4
   - Tím se TOP_K častěji vybírá ten, kdo má právo mluvit

2. ZMĚNA: Cap engagement growth per turn
   - Max růst za tah: +0.45
   - Addressed + question používá max() místo sčítání
   - Zabraňuje +0.60 skokům

3. ZMĚNA: unaddressed_decay snížen
   - Původně: 0.08
   - Teď: 0.06 (méně agresivní)

4. ZMĚNA: detect_question_to_npc pro 2 NPC
   - Pro 2 NPC: každá otázka "?" je automaticky na druhého
   - Pro 3+ NPC: vyžaduje oslovení (jako dřív)

===========================================
AKTUÁLNÍ ARCHITEKTURA
===========================================

```
process_turn():
    1. Update stavů (on_turn_start)
    2. Generuj WorldEvent
    3. Pro každé NPC:
       a. Detekuj oslovení/otázku
       b. Update drives (speak, stay, engagement)
    4. Skóruj NPC a vyber TOP K (včetně engagement bonus/penalty)
    5. Pro každé NPC v TOP K:
       a. state.on_selected(turn)
       b. === PERMISSION GATE ===
          - Pokud engagement < 0.25 AND speak < 0.65:
            - Vrať ACTION nebo NOTHING bez AI volání
       c. Zavolej AI
       d. Pokud response:
          - result = _process_response(response, event)
          - scene_context.on_turn_end()  ← JEDNOU tady
          - return result
    6. Žádná odpověď:
       - scene_context.on_silence()
       - scene_context.on_turn_end()  ← JEDNOU tady
       - return None
```

===========================================
ENGAGEMENT DRIVE - AKTUÁLNÍ PRAVIDLA
===========================================

engagement_drive ROSTE při:
- Přímé oslovení jménem/titulem: +0.35
- Otázka směřovaná na NPC: +0.25 (použije se max, ne součet!)
- PRESSURE event cílící na NPC: +0.10 * intensity
- **Cap:** max +0.45 růst za tah

engagement_drive KLESÁ při:
- SILENCE (bez oslovení): -0.05
- NPC bylo vybráno ale ne osloveno (minulý tah): -0.06

```python
def _update_engagement_drive(...):
    original_drive = state.engagement_drive
    drive = original_drive

    # 1+2. Přímé oslovení + Otázka -> použij MAX (ne součet!)
    address_boost = 0.0
    if was_addressed:
        address_boost = 0.35
        state.on_addressed(turn)
    if was_asked_question:
        address_boost = max(address_boost, 0.25)  # MAX!
        state.on_addressed(turn)
    drive += address_boost

    # 3. PRESSURE -> mírný boost
    if PRESSURE and target == npc_id:
        drive += 0.10 * intensity

    # 4. SILENCE -> decay
    if SILENCE and not addressed:
        drive -= 0.05

    # 5. Vybráno ale ne osloveno -> decay
    if last_selected == turn - 1 and last_addressed < last_selected:
        drive -= 0.06

    # 6. CAP růstu za tah
    growth = drive - original_drive
    if growth > 0.45:
        drive = original_drive + 0.45

    state.engagement_drive = clamp(drive, 0, 1)
```

===========================================
SCORER - AKTUÁLNÍ VÝPOČET
===========================================

```python
score = speak_drive * energy           # Základ
      + 0.4 * intensity                # PRESSURE bonus
      + 0.2 * intensity * mluvnost     # STIMULUS bonus
      - 0.3 * cooldown_turns           # Cooldown penalty
      - 0.2 * (0.3 - energy)           # Low energy penalty
      - 0.3 * anti_rep_penalty         # Repetition penalty
      - just_acted_penalty             # -0.25 / -0.125
      - just_selected_penalty          # -0.15 / -0.075
      + engagement_mod                 # NOVÉ v3.5

# Engagement modifikátor:
if engagement >= 0.5:
    engagement_mod = +0.15 * (engagement - 0.5) * 2  # max +0.15
elif engagement < 0.25:
    engagement_mod = -0.20 * (0.25 - engagement) * 4  # max -0.20
else:
    engagement_mod = 0
```

===========================================
DETECT_QUESTION_TO_NPC - AKTUÁLNÍ LOGIKA
===========================================

```python
def detect_question_to_npc(text, npc_name, npc_titul, total_npcs_in_scene=2):
    if "?" not in text:
        return False

    # Pro 2 NPC: každá otázka je automaticky na druhého
    if total_npcs_in_scene == 2:
        return True

    # Pro 3+ NPC: vyžaduje oslovení
    return detect_addressing(text, npc_name, npc_titul)
```

Test výsledky:
- "Jak se máte?" (2 NPC) -> True
- "Jak se máte?" (3 NPC) -> False
- "Babičko, jak se máte?" (3 NPC) -> True

===========================================
PERMISSION GATE - AKTUÁLNÍ LOGIKA
===========================================

```python
if state.engagement_drive < 0.25 and state.speak_drive < 0.65:
    # Přeskoč AI volání
    if state.speak_drive > 0.45:
        return ACTION(random.choice(generic_actions))
    else:
        return NOTHING
```

Generic actions:
- "Pozoruje okolí."
- "Zamyšleně se dívá na moře."
- "Pousměje se."

===========================================
on_turn_end() - POTVRZENO SPRÁVNÉ
===========================================

on_turn_end() se volá JEDNOU za tah v process_turn():
- Po Permission Gate větvi (řádek 337)
- Po AI odpovědi (řádek 370)
- Po žádné odpovědi (řádek 375)

_process_response() NEVOLÁ on_turn_end() - to je správně.

===========================================
SOUBORY ZMĚNĚNÉ V v3.5
===========================================

1. game/engine/scorer.py
   - Přidány engagement_bonus a low_engagement_penalty parametry
   - Přidán engagement_mod do výpočtu skóre

2. game/engine/drive_update.py
   - engagement_unaddressed_decay: 0.08 -> 0.06
   - engagement_max_growth_per_turn: 0.45 (nový parametr)
   - addressed + question používá max() místo sčítání
   - Cap na růst za tah

3. game/engine/behavior_engine.py
   - detect_question_to_npc předává total_npcs_in_scene

===========================================
TESTY - VŠECHNY PROŠLY
===========================================

Test 1: Engagement v scoreru
- High engagement (0.7): engagement_mod = +0.060
- Low engagement (0.15): engagement_mod = -0.080

Test 2: Cap na engagement growth
- Po addressed+question+pressure: 0.75 (capped)
- Po addressed only: 0.65

Test 3: detect_question pro 2 NPC
- "Jak se máte?" (2 NPC): True
- "Jak se máte?" (3 NPC): False
- "Karle, jak se máte?" (3 NPC): True

===========================================
ZMĚNY OD PŘEDCHOZÍCH VERZÍ (souhrn)
===========================================

v3.5:
- Engagement v scoringu (bonus/penalizace)
- Cap engagement growth per turn na +0.45
- unaddressed_decay snížen na 0.06
- detect_question: pro 2 NPC stačí "?"
- max() místo sčítání pro addressed+question

v3.4:
- engagement_drive ("sociální povolení")
- Permission Gate před AI voláním
- detect_question_to_npc()
- last_addressed_turn tracking

v3.3:
- on_turn_end() pouze jednou v process_turn()
- last_selected_turn + just_selected_penalty
- detect_addressing() s regex (ne substring)

v3.2:
- just_acted_penalty pro střídání NPC
- last_acted_turn tracking
- nothing se nepočítá jako akce

v3.1:
- record_speech se volá VŽDY (i při downgrade/reject)

v3.0:
- Anti-repetition sleduje začátky replik
- Detekce vokativů pro češtinu

===========================================
OTÁZKY PRO REVIEW
===========================================

1. Je engagement v scoringu správně nastavený?
   - bonus: +0.15 při eng ≥ 0.5
   - penalizace: -0.20 při eng < 0.25

2. Je cap +0.45 na růst engagement vhodný?
   - Nebo by měl být nižší (třeba +0.40)?

3. Je logika max(addressed, question) správná?
   - Alternativa: addressed se sčítá, ale question ne?

4. Další návrhy na zlepšení?
