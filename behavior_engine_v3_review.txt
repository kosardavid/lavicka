===========================================
BEHAVIOR ENGINE v3.6 - REVIEW PRO CHATGPT
===========================================
Datum: 2025-12-23
Verze: v3.6 (opravy z Claude Code review)

ZMENY OD v3.5:

1. OPRAVA: Reset _consecutive_speaker_count pri non-speech
   - THOUGHT, ACTION, NOTHING nyni resetuji _last_speaker_id a _consecutive_speaker_count
   - Tim se umozni NPC znovu mluvit po pauze (ne "uz mluvil 2x")

2. OPRAVA: Hard duplicate check
   - Pokud NPC vygeneruje identicky text jako jeho posledni speech -> downgrade na ACTION
   - Pouziva _normalize_text() pro porovnani (lowercase, bez interpunkce)

3. OPRAVA: _history jako single source of truth
   - Vsechny odpovedi se ukladaji do _history
   - _get_last_text_from_history() a _get_last_speaker_from_history() ctou z historie

4. OPRAVA: record_speech() pouze pro finalni speech
   - Pokud je speech downgradeovana na thought/action, record_speech() se NEVOLA
   - Tim se nezanasi anti-repetition tracker

5. OPRAVA: on_turn_end() pouze jednou
   - Vsechny vetve process_turn() konci na jedinem miste kde se vola on_turn_end()

===========================================
AKTUALNI ARCHITEKTURA
===========================================

```
process_turn():
    1. Update stavu (on_turn_start)
    2. Generuj WorldEvent
    3. Pro kazde NPC:
       a. Detekuj osloveni/otazku
       b. Update drives (speak, stay, engagement)
    4. Skoruj NPC a vyber TOP K (vcetne engagement bonus/penalty)
    5. Pro kazde NPC v TOP K:
       a. state.on_selected(turn)
       b. === PERMISSION GATE ===
          - Pokud engagement < 0.25 AND speak < 0.65:
            - Vrat ACTION nebo NOTHING bez AI volani
       c. === MAX CONSECUTIVE SPEAKER ===
          - Pokud tento NPC uz mluvil 2x za sebou:
            - Vrat ACTION bez AI volani
       d. Zavolej AI
       e. Pokud response:
          - result = _process_response(response, event)
          - break (jdi na spolecny on_turn_end)
    6. Zadna odpoved:
       - scene_context.on_silence()
    7. === JEDINE MISTO on_turn_end() ===
       - scene_context.on_turn_end()
       - return result
```

===========================================
_process_response() FLOW
===========================================

```python
def _process_response(response, world_event):
    if response.is_speech():
        # 1. HARD DUPLICATE CHECK
        last_speech = _get_last_speech_by_npc(npc_id)
        if normalize(response.text) == normalize(last_speech):
            -> downgrade na ACTION, return

        # 2. ANTI-REPETITION CHECK
        action = anti_rep.get_rejection_action(npc_id, response.text)
        if action == "reject":
            -> zmena na NOTHING, return
        elif action == "downgrade_to_thought":
            -> zmena na THOUGHT
        elif action == "downgrade_to_action":
            -> zmena na ACTION

    # 3. ZPRACUJ PODLE FINALNIHO TYPU
    if speech:
        state.on_spoke()
        scene_context.on_speech()
        anti_rep.record_speech()  # AZ TADY!
        _append_to_history("speech")
        # Update consecutive:
        if _last_speaker_id == npc_id:
            _consecutive_speaker_count += 1
        else:
            _consecutive_speaker_count = 1
        _last_speaker_id = npc_id

    elif thought:
        state.on_acted()
        scene_context.on_thought()
        _append_to_history("thought")
        # RESET consecutive:
        _last_speaker_id = None
        _consecutive_speaker_count = 0

    elif action:
        state.on_acted()
        scene_context.on_action()
        _append_to_history("action")
        # RESET consecutive:
        _last_speaker_id = None
        _consecutive_speaker_count = 0

    elif nothing:
        scene_context.on_nothing()
        _append_to_history("nothing")
        # RESET consecutive:
        _last_speaker_id = None
        _consecutive_speaker_count = 0
```

===========================================
ENGAGEMENT DRIVE - AKTUALNI PRAVIDLA
===========================================

engagement_drive ROSTE pri:
- Prime osloveni jmenem/titulem: +0.35
- Otazka smerovana na NPC: +0.25 (pouzije se max, ne soucet!)
- PRESSURE event cilici na NPC: +0.10 * intensity
- **Cap:** max +0.45 rust za tah

engagement_drive KLESA pri:
- SILENCE (bez osloveni): -0.05
- NPC bylo vybrano ale ne osloveno (minuly tah): -0.06

===========================================
SCORER - AKTUALNI VYPOCET
===========================================

```python
score = speak_drive * energy           # Zaklad
      + 0.4 * intensity                # PRESSURE bonus
      + 0.2 * intensity * mluvnost     # STIMULUS bonus
      - 0.3 * cooldown_turns           # Cooldown penalty
      - 0.2 * (0.3 - energy)           # Low energy penalty
      - 0.3 * anti_rep_penalty         # Repetition penalty
      - just_acted_penalty             # -0.25 / -0.125
      - just_selected_penalty          # -0.15 / -0.075
      + engagement_mod                 # Engagement bonus/penalty

# Engagement modifikator:
if engagement >= 0.5:
    engagement_mod = +0.15 * (engagement - 0.5) * 2  # max +0.15
elif engagement < 0.25:
    engagement_mod = -0.20 * (0.25 - engagement) * 4  # max -0.20
else:
    engagement_mod = 0
```

===========================================
MAX CONSECUTIVE SPEAKER
===========================================

```python
# V process_turn(), PRED AI volanim:
if _last_speaker_id == npc_id and _consecutive_speaker_count >= 2:
    # Vrat ACTION bez AI volani
    return ACTION("Chvili mlci a pozoruje okoli.")
```

Toto zajistuje, ze zadne NPC nemuze mluvit vic nez 2x za sebou.
Po ACTION/THOUGHT/NOTHING se counter RESETUJE na 0.

===========================================
HARD DUPLICATE CHECK
===========================================

```python
# V _process_response(), PRED anti-rep checkem:
last_speech = _get_last_speech_by_npc(npc_id)
if last_speech:
    if _normalize_text(response.text) == _normalize_text(last_speech):
        # Identicky text -> downgrade na ACTION
        return ACTION("Podiva se na more.")

def _normalize_text(text):
    normalized = text.lower().strip()
    normalized = re.sub(r'\s+', ' ', normalized)
    normalized = re.sub(r'[,.;:!?..."\']+$', '', normalized)
    return normalized
```

===========================================
ANTI-REPETITION PRAHY
===========================================

```python
penalty = anti_rep.get_penalty(npc_id, text)

if penalty < 0.4:
    return "accept"           # Projde
elif penalty < 0.6:
    return "downgrade_to_thought"
elif penalty < 0.8:
    return "downgrade_to_action"
else:
    return "reject"           # Zmena na NOTHING
```

===========================================
TESTY - VSECHNY PROSLY
===========================================

Test 1: Hard duplicate detection
- Input: 2x identicky text
- Output: 1. speech, 2. action
- PASSED

Test 2: Reset consecutive pri ACTION
- Input: speech, speech (-> action kvuli anti-rep), speech
- Output: count se spravne resetuje
- PASSED

Test 3: Max consecutive speaker
- Input: 3x speech od stejneho NPC
- Output: 1. speech (count=1), 2. speech (count=2), 3. action (blocked)
- PASSED

===========================================
ZNAME LIMITACE
===========================================

1. Anti-repetition muze byt prilis citlivy
   - Repliky sdilici bezna slova (more, klid, pohled) mohou byt penalizovany
   - Mozna zvysit prahy nebo upravit _extract_phrases()

2. "Prave rekl/a" ukazuje posledni SPEECH od souseda
   - Pokud soused dela jen thought/action, neupdatuje se
   - To je zamerne (ukazuje posledni vyrok), ale muze byt matouci

===========================================
SOUBORY ZMENENE V v3.6
===========================================

1. game/engine/behavior_engine.py
   - Reset _consecutive_speaker_count pri THOUGHT/ACTION/NOTHING
   - Hard duplicate check pred anti-rep
   - _history jako single source of truth

===========================================
OTAZKY PRO REVIEW
===========================================

1. Je logika spravna?
   - Hard duplicate -> downgrade na ACTION
   - Anti-rep downgrade -> reset consecutive counter

2. Mame nejaky edge case ktery jsme prehledly?
   - Napriklad: co kdyz AI vrati prazdny text?

3. Je anti-repetition prilis agresivni?
   - Mozna zvysit prahy (0.4 -> 0.5, 0.6 -> 0.7)?

