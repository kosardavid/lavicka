===========================================
BEHAVIOR ENGINE v3.3 - REVIEW PRO CHATGPT
===========================================
Datum: 2025-12-23
Verze: v3.3 (opravy z ChatGPT review)

ZMĚNY OD v3.2:

1. OPRAVA: on_turn_end() se nyní volá pouze JEDNOU
   - Dříve: voláno uvnitř _process_response() + v process_turn()
   - Teď: voláno POUZE na konci process_turn() po zpracování odpovědi
   - Řeší: turn_number se inkrementoval víckrát za tah

2. NOVÉ: last_selected_turn + penalizace za výběr
   - Problém: NPC vrátí nothing, je znovu vybráno (díra v systému)
   - Řešení: last_selected_turn sleduje kdy byl NPC vybrán pro AI
   - Penalizace: tento tah -0.15, minulý tah -0.075
   - on_selected() se volá VŽDY když je NPC vybráno (i když vrátí nothing)

3. OPRAVA: detect_addressing() používá regex
   - Dříve: substring matching ("babička" in text) - false positives
   - Teď: regex s word boundary + kontrola začátku věty/čárky
   - Nechytá: "babičkami", "babičkám" (plurály, pády)
   - Chytá: "Babičko, ..." (vokativ na začátku), ", Karle," (po čárce)

===========================================
ARCHITEKTURA process_turn() a _process_response()
===========================================

```
process_turn():
    1. Update stavů (on_turn_start)
    2. Generuj WorldEvent
    3. Update drives
    4. Skóruj NPC a vyber TOP K
    5. Pro každé NPC v TOP K:
       a. state.on_selected(turn)  ← NOVÉ: zaznamenej výběr
       b. Zavolej AI
       c. Pokud response:
          - result = _process_response(response, event)
          - scene_context.on_turn_end()  ← JEDNOU tady
          - return result
    6. Žádná odpověď:
       - scene_context.on_silence()
       - scene_context.on_turn_end()  ← JEDNOU tady
       - return None

_process_response():
    - Zpracuje odpověď od AI
    - Aktualizuje stavy NPC a scény
    - NEVOLÁ on_turn_end() ← odstraněno
    - Vrací NPCResponse
```

===========================================
SOUBOR: game/engine/types.py (změny)
===========================================

```python
@dataclass
class NPCBehaviorState:
    npc_id: str
    speak_drive: float = 0.3
    stay_drive: float = 0.7
    cooldown_turns: int = 0
    energy: float = 1.0
    speeches_count: int = 0
    last_spoke_turn: int = -1
    last_acted_turn: int = -1
    last_selected_turn: int = -1  # NOVÉ: kdy byl vybrán pro AI

    def on_selected(self, current_turn: int) -> None:
        """Zavoláno když byl NPC vybrán pro AI volání (i když vrátí nothing)."""
        self.last_selected_turn = current_turn
```

===========================================
SOUBOR: game/engine/scorer.py (změny)
===========================================

```python
def __init__(
    self,
    pressure_bonus: float = 0.4,
    stimulus_bonus: float = 0.2,
    cooldown_penalty: float = 0.3,
    low_energy_penalty: float = 0.2,
    just_acted_penalty: float = 0.25,
    just_selected_penalty: float = 0.15,  # NOVÉ
):

def score_npc(...):
    # ... existující penalizace ...

    # Penalizace za právě provedenou akci
    just_acted = 0.0
    if state.last_acted_turn >= 0:
        turns_since = current_turn - state.last_acted_turn
        if turns_since == 0:
            just_acted = -0.25
        elif turns_since == 1:
            just_acted = -0.125

    # NOVÉ: Penalizace za nedávný výběr (řeší díru v nothing)
    just_selected = 0.0
    if state.last_selected_turn >= 0:
        turns_since = current_turn - state.last_selected_turn
        if turns_since == 0:
            just_selected = -0.15
        elif turns_since == 1:
            just_selected = -0.075

    total = base + pressure + stimulus + cooldown + energy_pen + anti_rep + just_acted + just_selected
```

===========================================
SOUBOR: game/engine/drive_update.py (změny)
===========================================

```python
import re  # NOVÉ: pro regex

def detect_addressing(last_response_text: str, npc_name: str, npc_titul: str = "") -> bool:
    """
    Detekuje oslovení pomocí regex - nechytá substrings!
    Kontroluje začátek věty nebo pozici po čárce.
    """
    if not last_response_text:
        return False

    text_lower = last_response_text.lower()

    # Kontrola jména (včetně vokativů) - celé slovo na začátku věty/po čárce
    if npc_name:
        vocative_forms = _generate_vocative_forms(npc_name)
        for form in vocative_forms:
            # Vzor: začátek nebo po interpunkci/čárce, pak jméno, pak konec slova
            pattern = rf'(^|[.!?]\s*|,\s*){re.escape(form)}\b'
            if re.search(pattern, text_lower):
                return True

    # Stejně pro titul...

    # Obecné oslovení (Vy, Ty) - na začátku věty
    addressing_pattern = r'(^|[.!?]\s*)(a\s+)?(vy|ty|vám|vás|tobě|tebe)\b'
    if re.search(addressing_pattern, text_lower):
        return True

    return False
```

===========================================
TEST VÝSLEDKY
===========================================

Test detect_addressing() s regex:

1. "Babičko, jak se máte?" + titul="Babička"
   -> True (vokativ na začátku)

2. "S babičkami je to těžké." + titul="Babička"
   -> False (substring - ne false positive!)

3. "Vlastičko, co myslíte?" + jmeno="Vlastička"
   -> True (vokativ)

4. "Ta Vlastička je hodná." + jmeno="Vlastička"
   -> False (uprostřed věty, ne oslovení)

5. "Vy jste z města?" + jmeno="Karel"
   -> True (Vy na začátku věty)

6. "Myslím že vy jste chytrý." + jmeno="Karel"
   -> False (vy uprostřed věty)

7. "Ale no tak, Karle, co to děláte?" + jmeno="Karel"
   -> True (Karle po čárce)

8. "Já jsem z Prahy. A vy?" + jmeno="Karel"
   -> True (A vy? po interpunkci)

=== Všechny testy prošly! ===


===========================================
OTÁZKY PRO REVIEW
===========================================

1. Je architektura on_turn_end() teď správná?
   - Volá se JEDNOU na konci process_turn()
   - _process_response() ho už nevolá

2. Je just_selected_penalty (0.15) správná hodnota?
   - Měla by být menší než just_acted (0.25)?
   - Nebo by měla být stejná?

3. Je regex pro detect_addressing() dostatečný?
   - Kontroluje: začátek textu, po . ! ?, po čárce
   - Nekontorluje: uprostřed věty bez čárky

4. Měly by se sloučit just_acted a just_selected penalizace?
   - Aktuálně: oddělené, sčítají se
   - Alternativa: max(just_acted, just_selected)?

5. Další návrhy na zlepšení?

===========================================
ZMĚNY OD PŘEDCHOZÍCH VERZÍ (souhrn)
===========================================

v3.3:
- on_turn_end() pouze jednou v process_turn()
- last_selected_turn + just_selected_penalty
- detect_addressing() s regex (ne substring)

v3.2:
- just_acted_penalty pro střídání NPC
- last_acted_turn tracking
- nothing se nepočítá jako akce

v3.1:
- record_speech se volá VŽDY (i při downgrade/reject)

v3.0:
- Anti-repetition sleduje začátky replik
- Detekce vokativů pro češtinu
- Odstranění filtru délky slov
